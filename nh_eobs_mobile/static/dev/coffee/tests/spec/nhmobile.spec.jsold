describe('NHMobile - Calls process_request function', function(){
    var mobile;
    var patient_info_data = [{
    	'full_name': 'Test Patient',
    	'gender': 'M',
    	'dob': '1988-01-12 00:00',
    	'location': 'Bed 1',
    	'parent_location': 'Ward 1',
    	'ews_score': 1,
    	'other_identifier': '012345678',
    	'patient_identifier': 'NHS012345678'
    }]

    beforeEach(function(){
        if (mobile == null) {
            mobile = new NHMobile();
        }
        //jasmine.Ajax.install();
        spyOn(NHMobile.prototype, 'process_request').and.callFake(function(){
    		var promise = new Promise();
    		promise.complete(patient_info_data);
    		//promise.complete(false);
    		return promise;
    		//return patient_info_data;
    	});
    });

    it("should call process_request when getting patient info ", function() {
        mobile.get_patient_info(1, mobile);
        expect(NHMobile.prototype.process_request).toHaveBeenCalledWith('GET', 'http://localhost:8069/mobile/patient/info/1');
    });

    it("should call process_request when calling ajax_get_patient_obs", function(){
       mobile.call_resource(mobile.urls.ajax_get_patient_obs(1));
       expect(NHMobile.prototype.process_request).toHaveBeenCalledWith('GET', 'http://localhost:8069/mobile/patient/ajax_obs/1', undefined);
    });

    it("should call process_request when calling ajax_task_cancellation_options", function(){
        mobile.call_resource(mobile.urls.ajax_task_cancellation_options());
        expect(NHMobile.prototype.process_request).toHaveBeenCalledWith('GET', 'http://localhost:8069/mobile/tasks/cancel_reasons/', undefined);
    });

    it("should call process_request when calling calculate_obs_score", function(){
        mobile.call_resource(mobile.urls.calculate_obs_score('gcs'), 'eyes=1&verbal=1&motor=1');
        expect(NHMobile.prototype.process_request).toHaveBeenCalledWith('POST', 'http://localhost:8069/mobile/observation/score/gcs', 'eyes=1&verbal=1&motor=1');
    });

    afterEach(function () {
        if (mobile != null) {
            mobile = null;
        }
        //jasmine.Ajax.uninstall();
    });
});

if(navigator.userAgent.indexOf('Trident') < 0){
    describe("NHMobile AJAX - process request is calling xhr send", function(){

        beforeEach(function(){
            spyOn(XMLHttpRequest.prototype, 'send');

        });



        it("is calling process_request which is triggering the XMLHTTPRequest", function() {
            var mobile = new NHMobile();
            mobile.get_patient_info(1);
            expect(XMLHttpRequest.prototype.send).toHaveBeenCalled();
        });

        it('is calling process_request which is sending args', function(){
            var mobile = new NHMobile();
            mobile.call_resource(mobile.urls.calculate_obs_score('gcs'), 'eyes=1&verbal=1&motor=1');
            expect(XMLHttpRequest.prototype.send).toHaveBeenCalledWith('eyes=1&verbal=1&motor=1');
        });

    });
}

describe("NHMobile AJAX - Invalid URL / server error", function(){
    var resp, resp_val;

    beforeEach(function(done){
        spyOn(NHModal.prototype, 'create_dialog').and.callThrough();
        var mobile = new NHMobile();
        resp = Promise.when(mobile.call_resource({url: 'meh', method: 'GET'})).then(function(data){
            resp_val = data;
            done();
        }, function(fail){
            console.log('promise failed');
            done();
        });

    });
    it('is showing modal when invalid ajax', function(done){
        expect(window.NHModal.prototype.create_dialog).toHaveBeenCalled();
        done();
    });

    afterEach(function(done){
        var test = document.getElementById('data_error');
        if(test != null){
            test.parentNode.removeChild(test);
        }
        done();
    });
});



describe('NHMobile - Patient Info', function(){
    var mobile;
    var patient_info_data = [{
        'full_name': 'Test Patient',
        'gender': 'M',
        'dob': '1988-01-12 00:00',
        'location': 'Bed 1',
        'ews_score': 1,
        'other_identifier': '012345678',
        'patient_identifier': 'NHS012345678'
    }];
    beforeEach(function(){
        var body_el = document.getElementsByTagName('body')[0];
        var test = document.getElementById('test');
        if (test != null) {
            test.parentNode.removeChild(test);
        }
        test_area = document.createElement('div');
        test_area.setAttribute('id', 'test');
        test_area.style.height = '500px';
        test_area.innerHTML = test_dom;
        body_el.appendChild(test_area);
        if (mobile == null) {
            mobile = new NHMobile();
        }
        var full_screen_modals = document.getElementsByClassName('full-modal');
        for(var i = 0; i < full_screen_modals.length; i++){
            var modal = full_screen_modals[i];
            modal.parentNode.removeChild(modal);
        }
    });

    it('Calls the server for patient information and displays in modal', function(){
        spyOn(NHMobile.prototype, 'process_request').and.callFake(function(){
            var promise = new Promise();
            promise.complete(patient_info_data);
            return promise;
        });
        spyOn(NHMobile.prototype, 'get_patient_info').and.callThrough();
        spyOn(NHModal.prototype, 'create_dialog').and.callThrough();
        mobile.get_patient_info(3, mobile);
        expect(NHMobile.prototype.process_request).toHaveBeenCalled();
        expect(NHModal.prototype.create_dialog).toHaveBeenCalled();
        expect(NHModal.prototype.create_dialog.calls.argsFor(0)[1]).toBe('patient_info');
        expect(NHModal.prototype.create_dialog.calls.argsFor(0)[2]).toBe(' Test Patient<span class="alignright">M</span>');
        expect(NHModal.prototype.create_dialog.calls.argsFor(0)[3]).toBe('<dl><dt>DOB:</dt><dd>1988-01-12</dd><dt>Location:</dt><dd>Bed 1</dd><dt class="twoline">Latest Score:</dt><dd class="twoline">1</dd><dt>Hospital ID:</dt><dd>012345678</dd><dt>NHS Number:</dt><dd>NHS012345678</dd></dl><p><a href="http://localhost:8069/mobile/patient/3" id="patient_obs_fullscreen" class="button patient_obs">View Patient Observation Data</a></p>');
    });

    it('Opens a fullscreen modal on pressing the View full patient obs button', function(){
        spyOn(NHMobile.prototype, 'process_request').and.callFake(function(){
            var promise = new Promise();
            promise.complete(patient_info_data);
            return promise;
        });
        spyOn(NHMobile.prototype, 'get_patient_info').and.callThrough();
        spyOn(NHModal.prototype, 'create_dialog').and.callThrough();
        spyOn(NHMobile.prototype, 'fullscreen_patient_info').and.callThrough();
        mobile.get_patient_info(3, mobile);
        expect(NHMobile.prototype.process_request).toHaveBeenCalled();
        expect(NHModal.prototype.create_dialog).toHaveBeenCalled();
        expect(NHModal.prototype.create_dialog.calls.argsFor(0)[1]).toBe('patient_info');
        expect(NHModal.prototype.create_dialog.calls.argsFor(0)[2]).toBe(' Test Patient<span class="alignright">M</span>');
        expect(NHModal.prototype.create_dialog.calls.argsFor(0)[3]).toBe('<dl><dt>DOB:</dt><dd>1988-01-12</dd><dt>Location:</dt><dd>Bed 1</dd><dt class="twoline">Latest Score:</dt><dd class="twoline">1</dd><dt>Hospital ID:</dt><dd>012345678</dd><dt>NHS Number:</dt><dd>NHS012345678</dd></dl><p><a href="http://localhost:8069/mobile/patient/3" id="patient_obs_fullscreen" class="button patient_obs">View Patient Observation Data</a></p>');
        var full_obs_button = document.getElementById('patient_obs_fullscreen');
        var click_event = document.createEvent('CustomEvent');
        click_event.initCustomEvent('click', false, true, false);
        full_obs_button.dispatchEvent(click_event);
        expect(NHMobile.prototype.fullscreen_patient_info).toHaveBeenCalled();
    });

    it('Closes a fullscreen modal on close button being pressed', function(){
        spyOn(NHMobile.prototype, 'process_request').and.callFake(function(){
            var promise = new Promise();
            promise.complete(patient_info_data);
            return promise;
        });
        spyOn(NHMobile.prototype, 'get_patient_info').and.callThrough();
        spyOn(NHModal.prototype, 'create_dialog').and.callThrough();
        spyOn(NHMobile.prototype, 'fullscreen_patient_info').and.callThrough();
        mobile.get_patient_info(3, mobile);
        expect(NHMobile.prototype.process_request).toHaveBeenCalled();
        expect(NHModal.prototype.create_dialog).toHaveBeenCalled();
        expect(NHModal.prototype.create_dialog.calls.argsFor(0)[1]).toBe('patient_info');
        expect(NHModal.prototype.create_dialog.calls.argsFor(0)[2]).toBe(' Test Patient<span class="alignright">M</span>');
        expect(NHModal.prototype.create_dialog.calls.argsFor(0)[3]).toBe('<dl><dt>DOB:</dt><dd>1988-01-12</dd><dt>Location:</dt><dd>Bed 1</dd><dt class="twoline">Latest Score:</dt><dd class="twoline">1</dd><dt>Hospital ID:</dt><dd>012345678</dd><dt>NHS Number:</dt><dd>NHS012345678</dd></dl><p><a href="http://localhost:8069/mobile/patient/3" id="patient_obs_fullscreen" class="button patient_obs">View Patient Observation Data</a></p>');
        var full_obs_button = document.getElementById('patient_obs_fullscreen');
        var click_event = document.createEvent('CustomEvent');
        click_event.initCustomEvent('click', false, true, false);
        full_obs_button.dispatchEvent(click_event);
        expect(NHMobile.prototype.fullscreen_patient_info).toHaveBeenCalled();

        var close_full_obs = document.getElementById('closeFullModal');
        var click_event = document.createEvent('CustomEvent');
        click_event.initCustomEvent('click', false, true, false);
        close_full_obs.dispatchEvent(click_event);
        var fullmodals = document.getElementsByClassName('full-modal');
        expect(fullmodals.length).toBe(0);

    });

    afterEach(function () {
        if (mobile != null) {
            mobile = null;
        }
        var test = document.getElementById('test');
        if (test != null) {
            test.parentNode.removeChild(test);
        }
        var full_screen_modals = document.getElementsByClassName('full-modal');
        for(var i = 0; i < full_screen_modals.length; i++){
            var modal = full_screen_modals[i];
            modal.parentNode.removeChild(modal);
        }
    });

});